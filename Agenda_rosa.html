<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENDA - REGISTRO FAC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 600px;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"], input[type="number"], input[type="email"] {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        textarea {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            resize: vertical;
        }
        h1 {
            color: #333;
        }
        .botones {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        /* Estilos de bot√≥n */
        button {
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        /* Estilos espec√≠ficos y forzados */
        button.btn-guardar {
            background-color: #008CBA !important; /* Azul */
        }
        button.btn-guardar:hover {
            background-color: #007399;
        }
        button.btn-modificar {
            background-color: #2196F3 !important; /* Azul claro/celeste */
        }
        button.btn-modificar:hover {
            background-color: #0b7dda;
        }
        button.btn-limpiar {
            background-color: #f44336 !important; /* Rojo */
        }
        button.btn-limpiar:hover {
            background-color: #da190b;
        }
        button.btn-eliminar {
            background-color: #ff9800 !important; /* Naranja */
        }
        button.btn-eliminar:hover {
            background-color: #e68900;
        }
        button.btn-exportar {
            background-color: #9c27b0 !important; /* Morado */
        }
        button.btn-exportar:hover {
            background-color: #7b1fa2;
        }

        .mensaje {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .exito {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .datos-guardados {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-width: 600px;
        }
        .datos-guardados h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>AGENDA - RECOGIDA - FAC</h1>
    
    <table>
        <thead>
            <tr>
                <th>Campo</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Nombre Completo:</td>
                <td><input type="text" id="nombre" name="nombre" placeholder="Introduce tu nombre completo"></td>
            </tr>
            <tr>
                <td>Direcci√≥n:</td>
                <td><input type="text" id="direccion" name="direccion" placeholder="Calle y n√∫mero"></td>
            </tr>
            <tr>
                <td>Tel√©fono:</td>
                <td><input type="text" id="telefono" name="telefono" placeholder="N√∫mero de tel√©fono (9 d√≠gitos)" inputmode="tel"></td>
            </tr>
            <tr>
                <td>Email:</td>
                <td><input type="email" id="email" name="email" placeholder="correo@ejemplo.com"></td>
            </tr>
            <tr>
                <td>Observaciones:</td> 
                <td><textarea id="observaciones" name="observaciones" rows="4" placeholder="Escribe tus observaciones aqu√≠..."></textarea></td>
            </tr>
        </tbody>
    </table>

    <div class="botones">
        <button onclick="guardarDatos()" class="btn-guardar">üíæ Guardar Registro</button>
        <button onclick="modificarRegistro()" class="btn-modificar">‚úçÔ∏è Modificar Registro</button>
        <button onclick="limpiarFormulario()" class="btn-limpiar">üóëÔ∏è Limpiar Formulario</button>
        <button onclick="eliminarDatosGuardados()" class="btn-eliminar">‚ùå Eliminar TODOS los Registros</button>
        <button onclick="Descargar_csv()" class="btn-exportar">üì§ Exportar Agenda a CSV</button>
    </div>

    <div id="mensaje" class="mensaje" style="display: none;"></div>

    <div id="datos-guardados" class="datos-guardados" style="display: none;">
        <h3>üìã Datos Guardados (Total de Registros):</h3>
        <div id="contenido-datos"></div>
    </div>

    <script>
        // Clave para localStorage
        const CLAVE_STORAGE = 'agenda_datos';

        // Funci√≥n para mostrar mensaje temporal
        function mostrarMensaje(texto, tipo) {
            const mensajeDiv = document.getElementById('mensaje');
            mensajeDiv.textContent = texto;
            mensajeDiv.className = `mensaje ${tipo}`;
            mensajeDiv.style.display = 'block';
            
            setTimeout(() => {
                mensajeDiv.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n auxiliar para limpiar solo los campos del formulario
        function limpiarCamposFormulario() {
            document.getElementById('nombre').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('email').value = '';
            document.getElementById('observaciones').value = '';
        }

        // --- INICIO: NUEVA FUNCI√ìN DE VALIDACI√ìN (CAMBIO 2) ---
        // Esta funci√≥n comprueba el tel√©fono y el email
        function validarCampos() {
            const telefono = document.getElementById('telefono').value.trim();
            const email = document.getElementById('email').value.trim();

            // 1. Validaci√≥n de Tel√©fono (si se ha rellenado)
            // Debe tener exactamente 9 d√≠gitos num√©ricos
            const telefonoRegex = /^\d{9}$/;
            if (telefono && !telefonoRegex.test(telefono)) {
                mostrarMensaje('‚ö†Ô∏è El Tel√©fono debe contener exactamente 9 d√≠gitos.', 'error');
                return false; // Falla la validaci√≥n
            }

            // 2. Validaci√≥n de Email (si se ha rellenado)
            // Debe tener un formato de email v√°lido (simple regex)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                mostrarMensaje('‚ö†Ô∏è El formato del Email no es v√°lido. Debe incluir @ y un dominio (ej: .com, .es).', 'error');
                return false; // Falla la validaci√≥n
            }

            return true; // Pasa todas las validaciones
        }
        // --- FIN: NUEVA FUNCI√ìN DE VALIDACI√ìN ---


        // Funci√≥n para guardar nuevo registro
        function guardarDatos() {
            const nombre = document.getElementById('nombre').value.trim();
            
            if (!nombre) {
                mostrarMensaje('‚ö†Ô∏è Por favor, introduce al menos el nombre antes de guardar.', 'error');
                return;
            }

            // CAMBIO 3: A√±adida la validaci√≥n antes de guardar
            if (!validarCampos()) {
                return; // Detener si la validaci√≥n falla
            }

            try {
                // Recuperar registros existentes (o inicializar un array vac√≠o [])
                let registros = JSON.parse(localStorage.getItem(CLAVE_STORAGE)) || [];

                // Si por alguna raz√≥n lee un objeto antiguo, lo convierte a array
                if (!Array.isArray(registros)) {
                    console.warn("localStorage conten√≠a un objeto simple, se ha limpiado.");
                    registros = [];
                }

                // Comprobar si ya existe un registro con ese nombre para sugerir MODIFICAR
                if (registros.some(r => r.nombre === nombre)) {
                    mostrarMensaje('‚ö† Ya existe un registro con ese Nombre. Usa "Modificar Registro" si quieres cambiarlo.', 'error');
                    return;
                }

                const datos = {
                    nombre: nombre,
                    direccion: document.getElementById('direccion').value,
                    telefono: document.getElementById('telefono').value,
                    email: document.getElementById('email').value,
                    observaciones: document.getElementById('observaciones').value,
                    fecha_guardado: new Date().toLocaleString('es-ES')
                };

                registros.push(datos);
                localStorage.setItem(CLAVE_STORAGE, JSON.stringify(registros));
                
                mostrarMensaje(`‚úÖ Nuevo registro a√±adido. Total: ${registros.length}.`, 'exito');
                limpiarCamposFormulario(); 
                
            } catch (error) {
                console.error('Error al guardar:', error);
                mostrarMensaje('‚ùå Error al guardar. Verifica el almacenamiento.', 'error');
            }
        }

        // FUNCI√ìN A√ëADIDA: Modificar un registro existente
        function modificarRegistro() {
            const nombreAEditar = document.getElementById('nombre').value.trim();

            if (!nombreAEditar) {
                mostrarMensaje('‚ö†Ô∏è El campo "Nombre Completo" es obligatorio para identificar qu√© registro modificar.', 'error');
                return;
            }

            // CAMBIO 4: A√±adida la validaci√≥n antes de modificar
            if (!validarCampos()) {
                return; // Detener si la validaci√≥n falla
            }

            try {
                let registros = JSON.parse(localStorage.getItem(CLAVE_STORAGE)) || [];
                
                // Si por alguna raz√≥n lee un objeto antiguo, lo evita
                if (!Array.isArray(registros)) {
                    mostrarMensaje('‚ùå Error interno: No hay registros v√°lidos para modificar.', 'error');
                    return;
                }

                // Encontrar el √≠ndice del registro a modificar
                const indice = registros.findIndex(r => r.nombre === nombreAEditar);

                if (indice === -1) {
                    mostrarMensaje('‚ùå No se encontr√≥ ning√∫n registro con ese Nombre Completo para modificar.', 'error');
                    return;
                }

                // Actualizar el registro en ese √≠ndice con los nuevos datos del formulario
                registros[indice] = {
                    nombre: nombreAEditar, // Se mantiene el nombre (la clave)
                    direccion: document.getElementById('direccion').value,
                    telefono: document.getElementById('telefono').value,
                    email: document.getElementById('email').value,
                    observaciones: document.getElementById('observaciones').value,
                    fecha_modificacion: new Date().toLocaleString('es-ES'), // A√±adimos fecha de modificaci√≥n
                    fecha_guardado: registros[indice].fecha_guardado // Mantenemos la fecha original de guardado
                };

                // Guardar la lista COMPLETA actualizada
                localStorage.setItem(CLAVE_STORAGE, JSON.stringify(registros));
                
                mostrarMensaje(`‚úçÔ∏è Registro de **${nombreAEditar}** modificado correctamente.`, 'exito');
                limpiarCamposFormulario(); 

            } catch (error) {
                console.error('Error al modificar:', error);
                mostrarMensaje('‚ùå Error al modificar el registro.', 'error');
            }
        }

        // Funci√≥n para limpiar formulario (usa la funci√≥n auxiliar)
        function limpiarFormulario() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los campos?')) {
                limpiarCamposFormulario();
                mostrarMensaje('üßπ Formulario limpiado correctamente.', 'exito');
            }
        }

        // Funci√≥n para eliminar TODOS los registros guardados
        function eliminarDatosGuardados() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar TODOS los registros guardados? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem(CLAVE_STORAGE);
                document.getElementById('datos-guardados').style.display = 'none';
                mostrarMensaje('üóëÔ∏è Todos los registros eliminados correctamente.', 'exito');
            }
        }

        // FUNCI√ìN FINAL: Exportar todos los datos guardados a CSV (Excel con soporte para tildes)
        function Descargar_csv() {
            let registrosGuardados = JSON.parse(localStorage.getItem(CLAVE_STORAGE)) || [];
            
            // Si por error la memoria tiene un objeto simple, se reinicia la lista
            if (!Array.isArray(registrosGuardados)) {
                registrosGuardados = [];
            }

            if (registrosGuardados.length === 0) {
                mostrarMensaje('‚ö†Ô∏è No hay registros guardados para exportar.', 'error');
                return;
            }

            const nombreBase = 'Agenda_Registros';

            // Definir encabezados, incluyendo la nueva columna de modificaci√≥n
            const encabezados = "Nombre Completo;Direcci√≥n;Tel√©fono;Email;Observaciones;Fecha Guardado;Fecha Modificaci√≥n\n";
            let contenidoFilas = "";

            registrosGuardados.forEach(datos => {
                const observacionesLimpias = (datos.observaciones || '').replace(/(\r\n|\n|\r)/gm, ' '); 
                
                // Si el campo de modificaci√≥n no existe, se pone un espacio
                const fechaModificacion = datos.fecha_modificacion || ' '; 

                const filaDatos = `${datos.nombre};${datos.direccion};${datos.telefono};${datos.email};${observacionesLimpias};${datos.fecha_guardado};${fechaModificacion}\n`;
                contenidoFilas += filaDatos;
            });

            // BOM para forzar UTF-8 en Excel (corrige tildes)
            const BOM = "\uFEFF"; 
            const contenido = BOM + encabezados + contenidoFilas;

            const blob = new Blob([contenido], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const enlace = document.createElement('a');
            enlace.href = url;
            enlace.download = `${nombreBase}_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}.csv`;

            document.body.appendChild(enlace);
            enlace.click();
            document.body.removeChild(enlace);
            URL.revokeObjectURL(url);

            mostrarMensaje(`üì§ ${registrosGuardados.length} registros exportados correctamente a CSV (Excel).`, 'exito');
        }
    </script>
</body>
</html>